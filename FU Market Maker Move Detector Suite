//@version=5
indicator("FU Market Maker Move Detector Suite", overlay=true)


//inputs
candleDifferenceScale = input.float(defval = 1.8, minval = 1, title = 'Zone Difference Scale', tooltip = 'The scale of how much a candle needs to be larger than a previous to be considered a zone. (candleChange / candleChange[1] > {value}, minimum value 1.0, default 1.8)', group = 'Zone Settings')

zoneOffset = input.int(defval = 15, minval = 0, title="Zone Extension", group = 'Display Settings', tooltip = 'How much to extend zones to the right of latest bar. (In bars)')
displayLowerTFZones = input.bool(false, title="Display Lower Timeframe Zones", group = 'Display Settings', tooltip = 'Whether to or not to display zones from a lower timeframe. ie. 2h zones on 4h timeframe (Recommended OFF).')

supplyEnable = input(true, title = "Enable Supply Zones", group = "Zone Personalization")
supplyColor = input.color(defval = color.rgb(242, 54, 69, 94), title = 'Supply Background Color', group = 'Zone Personalization')
supplyBorderColor = input.color(defval = color.rgb(209, 212, 220, 90), title = 'Supply Border Color', group = 'Zone Personalization')

demandEnable = input(true, title = "Enable Demand Zones", group = "Zone Personalization")
demandColor = input.color(defval = color.rgb(76, 175, 80, 94), title = 'Demand Background Color', group = 'Zone Personalization')
demandBorderColor = input.color(defval = color.rgb(209, 212, 220, 80), title = 'Demand Border Color', group = 'Zone Personalization')

textEnable = input(true, title = "Display Text", group = 'Text Settings')
displayHL = input.bool(false, title="Display High/Low", group = 'Text Settings', tooltip = 'Whether to or not to display the tops and bottoms of a zone as text. ie. Top: 4000.00 Bottom: 3900.00.')
textColor = input.color(defval = color.rgb(255, 255, 255), title = 'Text Color', group = 'Text Settings')
textSize = input.string("Small", title="Text Size", options=["Auto", "Tiny", "Small", "Normal", "Large", "Huge"], group = 'Text Settings')
halign = input.string("Right", title="Horizontal Alignment", options=["Left", "Center", "Right"], group = 'Text Settings')
supplyValign = input.string("Bottom", title="Vertical Alignment (Supply)", options=["Top", "Center", "Bottom"], group = 'Text Settings')
demandValign = input.string("Top", title="Vertical Alignment (Demand)", options=["Top", "Center", "Bottom"], group = 'Text Settings')

displayFormingZones = input.bool(false, title="Show Forming Zones", group = 'Timeframe Options', tooltip = 'Shows zones that could potentially form (unclosed candles)')
display5m = input.bool(true, title="Show 5m Zones", group = 'Timeframe Options')
display15m = input.bool(true, title="Show 15m Zones", group = 'Timeframe Options')
display30m = input.bool(true, title="Show 30m Zones", group = 'Timeframe Options')
display45m = input.bool(true, title="Show 45m Zones", group = 'Timeframe Options')
display1h = input.bool(true, title="Show 1h Zones", group = 'Timeframe Options')
display2h = input.bool(true, title="Show 2h Zones", group = 'Timeframe Options')
display3h = input.bool(true, title="Show 3h Zones", group = 'Timeframe Options')
display4h = input.bool(true, title="Show 4h Zones", group = 'Timeframe Options')
displayD = input.bool(false, title="Show Daily Zones", group = 'Timeframe Options')
displayW = input.bool(false, title="Show Weekly Zones", group = 'Timeframe Options')

// variables
currentTimeframe = timeframe.period


if currentTimeframe == 'D'
    currentTimeframe := '1440'
if currentTimeframe == 'W'
    currentTimeframe := '10080'
if displayLowerTFZones
    currentTimeframe := '1'

momentCTD = math.round(time(timeframe.period) + (zoneOffset * 60000 * str.tonumber(currentTimeframe)))




if textSize == 'Auto'
    textSize := size.auto
if textSize == 'Tiny'
    textSize := size.tiny
if textSize == 'Small'
    textSize := size.small
if textSize == 'Normal'
    textSize := size.normal
if textSize == 'Large'
    textSize := size.large
if textSize == 'Huge'
    textSize := size.huge

if halign == 'Left'
    halign := text.align_left
if halign == 'Center'
    halign := text.align_center
if halign == 'Right'
    halign := text.align_right

if supplyValign == 'Bottom'
    supplyValign := text.align_bottom
if supplyValign == 'Center'
    supplyValign := text.align_center
if supplyValign == 'Top'
    supplyValign := text.align_top

if demandValign == 'Bottom'
    demandValign := text.align_bottom
if demandValign == 'Center'
    demandValign := text.align_center
if demandValign == 'Top'
    demandValign := text.align_top

var box[] supply_HT = array.new_box()
var box[] demand_HT = array.new_box()

//plotting zones

createSupplyDemandZones(timeframe) =>

    [open_HT, high_HT, low_HT, close_HT] = request.security(syminfo.tickerid, timeframe, [open[1], high[1], low[1], close[1]], lookahead = barmerge.lookahead_on)

    var timeframeFormatted = ''

    if timeframe == '1'
        timeframeFormatted := '1m'
    else if timeframe == '3'
        timeframeFormatted := '3m'
    else if timeframe == '5'
        timeframeFormatted := '5m'
    else if timeframe == '15'
        timeframeFormatted := '15m'
    else if timeframe == '30'
        timeframeFormatted := '30m'
    else if timeframe == '45'
        timeframeFormatted := '45m'
    else if timeframe == '60'
        timeframeFormatted := '1h'
    else if timeframe == '120'
        timeframeFormatted := '2h'
    else if timeframe == '180'
        timeframeFormatted := '3h'
    else if timeframe == '240'
        timeframeFormatted := '4h'
    else if timeframe == 'D'
        timeframeFormatted := 'D'
    else if timeframe == 'W'
        timeframeFormatted := 'W'

    redCandle_HT = close_HT < open_HT
    greenCandle_HT = close_HT > open_HT
    neutralCandle_HT = close_HT == open_HT
    candleChange_HT = math.abs(close_HT - open_HT)

    var float bottomBox_HT = na
    var float topBox_HT = na
    momentCTD_HT = time(timeframe)[2]

    if (((redCandle_HT and greenCandle_HT[1]) or (redCandle_HT and neutralCandle_HT[1])) and (candleChange_HT / candleChange_HT[1]) >= candleDifferenceScale and (barstate.isconfirmed[1] or displayFormingZones) and supplyEnable and close_HT[1] >= close_HT and open_HT[1] <= open_HT)
        if displayFormingZones and barstate.isconfirmed[1] == false
            timeframeFormatted := timeframeFormatted + '(Forming)'
        if displayHL
            timeframeFormatted := timeframeFormatted + '\nTop: ' + str.tostring(topBox_HT) + '\nBottom: ' + str.tostring(open_HT[1])

        if high_HT >= high_HT[1]
            topBox_HT := high_HT
        else 
            topBox_HT := high_HT[1]

        box supply = box.new(left=momentCTD_HT, top=topBox_HT, right=momentCTD, bgcolor=supplyColor, bottom=open_HT[1], xloc=xloc.bar_time)
        box.set_border_color(supply, supplyBorderColor)
        if textEnable
            box.set_text(supply, timeframeFormatted)
            box.set_text_size(supply, textSize)
            box.set_text_color(supply, textColor)
            box.set_text_halign(supply, halign)
            box.set_text_valign(supply, supplyValign)
        array.push(supply_HT, supply)

    if (((greenCandle_HT and redCandle_HT[1]) or (greenCandle_HT and neutralCandle_HT[1])) and (candleChange_HT / candleChange_HT[1]) >= candleDifferenceScale and (barstate.isconfirmed[1] or displayFormingZones) and demandEnable and close_HT[1] <= close_HT and open_HT[1] >= open_HT)
        if displayFormingZones and barstate.isconfirmed[1] == false
            timeframeFormatted := timeframeFormatted + ' (Forming)'    
        if displayHL
            timeframeFormatted := timeframeFormatted + '\nTop: ' + str.tostring(open_HT[1]) + '\nBottom: ' + str.tostring(bottomBox_HT)

        if low_HT <= low_HT[1]
            bottomBox_HT := low_HT
        else 
            bottomBox_HT := low_HT[1]

        box demand = box.new(left=momentCTD_HT, top=open_HT[1], right=momentCTD, bottom=bottomBox_HT, bgcolor=demandColor, xloc=xloc.bar_time)
        box.set_border_color(demand, demandBorderColor)
        if textEnable
            box.set_text(demand, timeframeFormatted)
            box.set_text_size(demand, textSize)
            box.set_text_color(demand, textColor)
            box.set_text_halign(demand, halign)
            box.set_text_valign(demand, demandValign)
        array.push(demand_HT, demand)

// initiation
if display5m and str.tonumber(currentTimeframe) <= 5
    createSupplyDemandZones('5')
if display15m and str.tonumber(currentTimeframe) <= 15
    createSupplyDemandZones('15')
if display30m and str.tonumber(currentTimeframe) <= 30
    createSupplyDemandZones('30')
if display45m and str.tonumber(currentTimeframe) <= 45
    createSupplyDemandZones('45')
if display1h and str.tonumber(currentTimeframe) <= 60
    createSupplyDemandZones('60') 
if display2h and str.tonumber(currentTimeframe) <= 120
    createSupplyDemandZones('120')
if display3h and str.tonumber(currentTimeframe) <= 180
    createSupplyDemandZones('180')
if display4h and str.tonumber(currentTimeframe) <= 240
    createSupplyDemandZones('240')
if displayD and str.tonumber(currentTimeframe) <= 1440
    createSupplyDemandZones('D')
if displayW and str.tonumber(currentTimeframe) <= 10080
    createSupplyDemandZones('W')
    // createSupplyDemandZones('M') // enabling this will break replay mode

// remove broken supply

i = 0
while i < array.size(supply_HT) and array.size(supply_HT) > 0
    box currentBox = array.get(supply_HT, i)
    float breakLevel = box.get_top(currentBox)
    if high > breakLevel 
        array.remove(supply_HT, i)
        box.delete(currentBox)
        int(na)
    else
        box.set_right(currentBox, momentCTD)
        i += 1
        int(na)

// remove broken demand

i2 = 0
while i2 < array.size(demand_HT) and array.size(demand_HT) > 0
    box currentBox = array.get(demand_HT, i2)
    float breakLevel = box.get_bottom(currentBox)
    if low < breakLevel 
        array.remove(demand_HT, i2)
        box.delete(currentBox)
        int(na)
    else
        box.set_right(currentBox, momentCTD)
        i2 += 1
        int(na)

// Inputs for styling
showBullFU    = input.bool(true, "Highlight Bullish FU Candle")
showBullATT   = input.bool(true, "Highlight Bullish ATT FU Candle")
showBearFU    = input.bool(true, "Highlight Bearish FU Candle")
showBearATT   = input.bool(true, "Highlight Bearish ATT FU Candle")
showDJBullFU    = input.bool(true, "Highlight Bullish FU Doji")
showDJBullATT   = input.bool(true, "Highlight Bullish ATT FU Doji")
showDJBearFU    = input.bool(true, "Highlight Bearish FU Doji")
showDJBearATT   = input.bool(true, "Highlight Bearish ATT FU Doji")

// Previous bar bullish flag
prevBullish = close[1] > open[1]

// FU Candle Conditions
bullishFU    = low < low[1] and close > high[1]
bullishATTFU = low < low[1] and close > (prevBullish ? close[1] : open[1])
bearishFU    = high > high[1] and close < low[1]
bearishATTFU = high > high[1] and close < (prevBullish ? open[1] : close[1])

// Optional: alert conditions
alertcondition(bullishFU,    title="Bullish FU Candle",      message="Bullish FU Candle detected at {{time}}")
alertcondition(bullishATTFU, title="Bullish ATT FU Candle", message="Bullish ATT FU Candle detected at {{time}}")
alertcondition(bearishFU,    title="Bearish FU Candle",      message="Bearish FU Candle detected at {{time}}")
alertcondition(bearishATTFU, title="Bearish ATT FU Candle", message="Bearish ATT FU Candle detected at {{time}}")


highBarNext = high
lowBarNext = low
highBarPrevious = high[2]
lowBarPrevious = low[2]
openBarPrevious = open[2]
closeBarPrevious = close[2]
openBarCurrent = open[1]
closeBarCurrent = close[1]

//If the Candle in index of 1 (the candle being detected as engulfing and imbalanced) and the next candle does not fill the imbalance, then a signal is generated. 
bullishEngulfing = openBarCurrent <= closeBarPrevious and openBarCurrent < openBarPrevious and 
   closeBarCurrent > openBarPrevious and lowBarNext > highBarPrevious
bearishEngulfing = openBarCurrent >= closeBarPrevious and openBarCurrent > openBarPrevious and 
   closeBarCurrent < openBarPrevious and highBarNext < lowBarPrevious
//Plot arrows to show the engulfing candle (note that the NEXT candle will be the one that leaves the imbalance, so offset is -1)
plotshape(bullishEngulfing, style=shape.triangleup, location=location.belowbar, color=color.green, offset=-1, size=size.tiny)
plotshape(bearishEngulfing, style=shape.triangledown, location=location.abovebar, color=color.red, offset=-1, size=size.tiny)

C_Len = 14 // ta.ema depth for bodyAvg
C_ShadowPercent = 5.0 // size of shadows
C_ShadowEqualsPercent = 100.0
C_DojiBodyPercent = 5.0
C_Factor = 2.0 // shows the number of times the shadow dominates the candlestick body

C_BodyHi = math.max(close, open)
C_BodyLo = math.min(close, open)
C_Body = C_BodyHi - C_BodyLo
C_BodyAvg = ta.ema(C_Body, C_Len)
C_SmallBody = C_Body < C_BodyAvg
C_LongBody = C_Body > C_BodyAvg
C_UpShadow = high - C_BodyHi
C_DnShadow = C_BodyLo - low
C_HasUpShadow = C_UpShadow > C_ShadowPercent / 100 * C_Body
C_HasDnShadow = C_DnShadow > C_ShadowPercent / 100 * C_Body
C_WhiteBody = open < close
C_BlackBody = open > close
C_Range = high-low
C_IsInsideBar = C_BodyHi[1] > C_BodyHi and C_BodyLo[1] < C_BodyLo
C_BodyMiddle = C_Body / 2 + C_BodyLo
C_ShadowEquals = C_UpShadow == C_DnShadow or (math.abs(C_UpShadow - C_DnShadow) / C_DnShadow * 100) < C_ShadowEqualsPercent and (math.abs(C_DnShadow - C_UpShadow) / C_UpShadow * 100) < C_ShadowEqualsPercent
C_IsDojiBody = C_Range > 0 and C_Body <= C_Range * C_DojiBodyPercent / 100
C_Doji = C_IsDojiBody and C_ShadowEquals

patternLabelPosLow = low - (ta.atr(30) * 0.6)
patternLabelPosHigh = high + (ta.atr(30) * 0.6)
label_color_neutral = input(color.gray, "Label Color Neutral")
C_DojiNumberOfCandles = 1
C_DragonflyDoji = C_IsDojiBody and C_UpShadow <= C_Body
C_GravestoneDojiOne = C_IsDojiBody and C_DnShadow <= C_Body
alertcondition(C_Doji and not C_DragonflyDoji and not C_GravestoneDojiOne, title = "New pattern detected", message = "New Doji pattern detected")
// if C_Doji and not C_DragonflyDoji and not C_GravestoneDojiOne
//    var ttDoji = "Doji\nWhen the open and close of a security are essentially equal to each other, a doji candle forms. The length of both upper and lower shadows may vary, causing the candlestick you are left with to either resemble a cross, an inverted cross, or a plus sign. Doji candles show the playout of buyer-seller indecision in a tug-of-war of sorts. As price moves either above or below the opening level during the session, the close is either at or near the opening level."
//    label.new(bar_index, patternLabelPosLow, text="D", style=label.style_label_up, color = label_color_neutral, textcolor=color.white, tooltip = ttDoji)
//plotshape(C_Doji and not C_DragonflyDoji and not C_GravestoneDojiOne, patternLabelPosLowstyle=shape.triangleup, location=location.belowbar, color=label_color_neutral, offset=-1, size=size.tiny)
bgcolor(C_Doji and not C_DragonflyDoji and not C_GravestoneDojiOne?label_color_neutral:na)

bgcolor(ta.highest(C_Doji?1:0, C_DojiNumberOfCandles)!=0 ? color.new(color.gray, 90) : na, offset=-(C_DojiNumberOfCandles-1))

// User input for maximum body size relative to full candle size
precision = input.float(0.25, minval=0.0001, title="Doji's Max Body Size")

// Doji condition
doji = math.abs(open - close) <= (high - low) * precision

// Color bars if Doji
// barcolor(doji ? color.yellow : na)
//if doji
//    label.new(bar_index, patternLabelPosLow, text="D", style=label.style_label_up, color = label_color_neutral, textcolor=color.white)
bgcolor(doji?label_color_neutral:na)
// === FU CANDLE CONDITIONS + DOJI FILTER ===
// Bullish FU: current low < previous low, current close > previous high
bullishDJFU    = doji and low < low[1] and close > high[1]
// Bullish ATT FU: same low rule, but compare close to prev close/open based on prev bullishness
bullishDJATTFU = doji and low < low[1] and close > (prevBullish ? close[1] : open[1])
// Bearish FU: current high > previous high, current close < previous low
bearishDJFU    = doji and high > high[1] and close < low[1]
// Bearish ATT FU: same high rule, but compare close to prev open/close based on prev bullishness
bearishDJATTFU = doji and high > high[1] and close < (prevBullish ? open[1] : close[1])

alertcondition(bullishDJFU,    title="Bullish Doji FU Candle",      message="Bullish FU Candle detected at {{time}}")
alertcondition(bullishDJATTFU, title="Bullish Doji ATT FU Candle", message="Bullish ATT FU Candle detected at {{time}}")
alertcondition(bearishDJFU,    title="Bearish Doji FU Candle",      message="Bearish FU Candle detected at {{time}}")
alertcondition(bearishDJATTFU, title="Bearish Doji ATT FU Candle", message="Bearish ATT FU Candle detected at {{time}}")


// Apply bar coloring
barcolor(    showBullFU    and bullishFU    ? color.new(color.green, 0) :    showBullATT   and bullishATTFU ? color.new(color.teal, 0)  :    showBearFU    and bearishFU    ? color.new(color.red, 0)   :    showBearATT   and bearishATTFU ? color.new(color.maroon,0)  :    na)
barcolor(    showDJBullFU    and bullishFU    ?  color.new(#7fbfcf, 0) :    showDJBullATT   and bullishDJATTFU ?   color.new(#05a6ce, 0) :    showDJBearFU    and bearishDJFU    ?  color.new(#a649f1, 0)  :    showDJBearATT   and bearishDJATTFU ?color.new(#4b0089, 0)   :    na)


// Conditions for a high bar (potential sell signal)
highBar =  close < low[1]  and open[1]<close[1]

// Conditions for a low bar (potential buy signal)
lowBar = close > high[1] and open[1]>close[1]

// Highlight background for confirmation
bgcolor(highBar ? color.new(color.red, 85) : na)
bgcolor(lowBar ? color.new(color.green, 85) : na)

//horns pattern

//------------------------------------------------------------------------------
//Settings
//-----------------------------------------------------------------------------{
threshold = input.float(0.05
  , step   = .01
  , minval = 0)
  
//Style
bull_css = input.color(#0cb51a, 'Bullish Horn Levels'
  , group = 'Style')

bear_css = input.color(#ff1100, 'Bearish Horn Levels'
  , group = 'Style')

//-----------------------------------------------------------------------------}
//Variables declaration
//-----------------------------------------------------------------------------{
var line conf = na
var line tp   = na

var target = 0.
var lvl    = 0.
var os     = 0
var cross  = 0

//-----------------------------------------------------------------------------}
//Rolling max/min & normalized distance
//-----------------------------------------------------------------------------{
max = math.max(high,high[1],high[2])
min = math.min(low,low[1],low[2])

top = math.abs(high - high[2])/(max-min)
btm = math.abs(low - low[2])/(max-min)

//-----------------------------------------------------------------------------}
//Detect and display horns alongside confirmation level/take profit
//-----------------------------------------------------------------------------{
n = bar_index

line.set_x2(conf, n)
line.set_x2(tp, n)

//Inverted Horn
if ta.crossunder(top, threshold) and high[1] < math.min(high, high[2])
    os := 0
    
    line.set_x2(conf, n - 2)
    line.set_x2(tp, n - 2)
    
    line.new(n
      , high
      , n - 2
      , high[2]
      , color = bear_css)
    
    lvl := min
    target := min - (max - min)
    
    conf := line.new(n
      , lvl
      , n + 1
      , lvl
      , style = line.style_dotted
      , color = bear_css)
      
    tp := line.new(n
      , target
      , n + 1
      , target
      , style = line.style_dashed
      , color = bear_css)

//Horn
if ta.crossunder(btm, threshold) and low[1] > math.max(low, low[2])
    os := 1
    
    line.set_x2(conf, n - 2)
    line.set_x2(tp, n - 2)
    
    line.new(n
      , low
      , n - 2
      , low[2]
      , color = bull_css)

    lvl := max
    target := max + (max - min)
    
    conf := line.new(n
      , lvl
      , n + 1
      , lvl
      , style = line.style_dotted
      , color = bull_css)
    
    tp := line.new(n
      , target
      , n + 1
      , target
      , style = line.style_dashed
      , color = bull_css)
    
//-----------------------------------------------------------------------------}
//Display breakout signals
//-----------------------------------------------------------------------------{
buy = ta.crossover(close, lvl) and os == 1 and cross == 1
sell = ta.crossunder(close, lvl) and os == 0 and cross == 1
cross := lvl != lvl[1] ? 1 : buy or sell ? 0 : cross[1]

//Plots
plotshape(buy ? low : na, "Buy Label"
  , style     = shape.labelup
  , location  = location.absolute
  , color     = #0cb51a
  , text      = "B"
  , textcolor = color.white
  , size      = size.tiny)

plotshape(sell ? high : na, "Sell Label"
  , style     = shape.labeldown
  , location  = location.absolute
  , color     = #ff1100
  , text      = "S"
  , textcolor = color.white
  , size      = size.tiny)

//-----------------------------------------------------------------------------}
